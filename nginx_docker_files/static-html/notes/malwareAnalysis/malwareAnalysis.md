# Malware analysis

This page purpose is to be a reference for myself in order to perform the art of malware analysis.  

The first thing we need is a virtual machine (VM) designed to perform malware analysis, the de facto VM is the Flare VM, designed by Mandiant
## Flare VM
Flare VM is a VM that it's install over vanilal windows 10. We can find de official github repository in here [flareVM github](https://github.com/mandiant/flare-vm).
In order to install the VM you must have a software for virtualization. The one I use is virtualbox, the reason is because it's free and widly used in the develpment comunity, (for example it's used by [Genymotion](https://www.genymotion.com/) to emulate rooted andriod devices, wich in turn are used to perform pentest in andriod applications).

On Kali linux I had some struggles with the installition of virtualbox, the most common solution I had is to update and upgrade everything with `apt update` and `apt upgrade` then instaling virtualbox. We must install the packages `virtualbox` and `virtualbox-ext-pack`, if it's not install automaticaly we must install `virtualbox-dkms` 

## REMnux 
[REMnux](https://remnux.org/) it's another VM for malware analysis, the diference with Flare VM is that REMnux is bases in linux and we can download it as a .ova file that can be imported to our virtualizing software
# Static analysis

## file type
with the command `file`

## find strings 
with command `pestr` `strings`, se puede modificar la longitud de las cadenas que reporta la herramienta y la codificación de las cadenas (una muestra puede tener cadena con distintas codificaciones)y se lo pasamos a `more` para ir bajando despacito. 

## PeStudio
Para traer las cosas estáticas en windows, una alternativa en linux es `peframe *archivo*` y Detect It Easy (DIE) y Exeinfo PE para windows y  `diec` para linux

## Números mágicos
Los ejecutables exe tienen como numeros mágicos 0x4D5A o MZ en ascii
Para zip es de PK
# Behavioral analysis

Process hacker, es como un task manager de windows. Es bueno que primero nos familiarizemos con el sisteme operativo limpio antes de compararlo con el equipo infectado.
Process monitor registra los cambios en el sistema operativo
Regshot - reporta cambios en las llaves de registro y hace la comparacioń con los snapshots que sacamos
ProcDOT

## persistencia

### windows 
en la carpeta/registry? Software\Microsoft\Windows\CurrentVersion\Run está lo que se ejecuta cuando bootea windows

## Resolver los DNS del malware
With `fakedns` in the ubuntu gateway


# From the curse in linkedin

### types of malware PUP (potentially unwanted programs)
Types of malware
- virus
- trojan 
- worm - does not require user interaction
### PUP
- spyware - extracts information
- adwarere

### non propagating malware
- executable
- injectalble module like DLL
- rootkit

### Virus delivery
- usb 
- email
    - executable code
- website
- search for propagation vectors

### worm delivery
- Search for vulnerable network targets
- need to avoid network floding

### Malware operation
- initial execution
- immediate execution
- install a backdoor

### Persistance 
On reboot, malware starts up automatically
- on windows, registry autostart extension point, althou very obvious place to look
- rootkit persistance on Master boot record, boot partition
- via DLLs 

Loadable kernel module or Driver operates in ring 0 and may run with privilaged 
Rootkit checks de procees list and make Direct Kernel object modification 

Domain generation algorithm used for C2 and zombies communication 

Father of bootnes es Zeus, code leaked in 2010, used for stealing online credential. targets computers and smarhphones

### Virus Construction kits
- creats virus without coding 
- produced executable or source code 

### Thesis: Transcriptase-Light: a Polymorphic Virus Construction Kit

### IoC
IoC can be:
- MD5 hash
- C2 domain name
- Malicious IP address
- Registry key known to be used by malware
- Facility 
- Timely, accurate and actioable
There is a free IoC sharing platfaor: IOC Bucket
### Stix
Is a format
### TAXII
Is a protocol of sharing
 
### IoA Indicator of Attack

### Anomaly Dectection System (ADS)
Initially deployed in learning mode and wheen ready deployed in detection mode
- Protoclo content anomalies
- Statistical 
- with many false positives

### Debuger
x32dbg

### Malware that changes
- polymorphic
    - De-obfuscator - not change
    - obfuscated code - changes
- metamorphic
    - malware code is changed
    - changes both the de-obfuscator and de obfuscated code

### Obfuscation technic
- Code permutation
- Code expansion 
- code shrinking
- garbage code insertion

### Information about APT
Is karpesky labs

### Malware reverse engerining 
- IDA is a good tool
- x32dbg
- cuckoo is a sandbox
- virusshare is a malware sample
- malware-traffic-analysis.net
- shadow brocker in github
- hybrid-analysis.com
- ghidra - it's open source
- codeBrowser 

### Packers
Packed file are harder to analys
- UPX 
